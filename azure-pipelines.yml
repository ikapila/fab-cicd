# Microsoft Fabric Data Engineering CI/CD Pipeline
# Automated deployment of Fabric artifacts across environments
#
# Features:
#   - Automatic change detection using Git (deploys only modified artifacts)
#   - Dependency-aware deployment ordering
#   - Per-environment service principals
#   - Manual approval gates for UAT and Production
#
# Change Detection:
#   By default, only artifacts that changed since last deployment are deployed.
#   This reduces deployment time by ~80% for typical changes.
#   To force full deployment, add --force-all flag to deploy_artifacts.py command.
#
# Tracking:
#   Deployment state is tracked in .deployment_tracking/{env}_last_commit.txt files.
#   These files are committed to the repository for persistence across pipeline runs.

trigger:
  branches:
    include:
      - main      # Production deployment
      - uat       # UAT deployment
      - dev       # Development deployment
  paths:
    include:
      - wsartifacts/Notebooks/**
      - wsartifacts/Sparkjobdefinitions/**
      - wsartifacts/Datapipelines/**
      - wsartifacts/Lakehouses/**
      - wsartifacts/Environments/**
      - wsartifacts/Reports/**
      - wsartifacts/Semanticmodels/**
      - wsartifacts/Paginatedreports/**
      - wsartifacts/Variablelibraries/**
      - wsartifacts/Views/**
      - config/**
      - scripts/**

variables:
  pythonVersion: '3.11'
  
pool:
  vmImage: 'ubuntu-latest'

stages:
  # ========================================
  # Stage 1: Build and Validate
  # ========================================
  - stage: Build
    displayName: 'Build and Validate'
    jobs:
      - job: ValidateArtifacts
        displayName: 'Validate Fabric Artifacts'
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(pythonVersion)'
            displayName: 'Use Python $(pythonVersion)'

          - script: |
              python -m pip install --upgrade pip
              pip install -r scripts/requirements.txt
            displayName: 'Install Python dependencies'

          - script: |
              echo "Validating all artifacts in wsartifacts/ with capitalized folder names..."
              python scripts/validate_artifacts.py --artifacts-root wsartifacts
            displayName: 'Validate All Artifacts'
            continueOnError: false

          - script: |
              echo "Validating notebook syntax..."
              python scripts/validate_notebooks.py --artifacts-root wsartifacts
            displayName: 'Validate Notebooks'
            continueOnError: false

          - script: |
              echo "Validating pipeline definitions..."
              python scripts/validate_pipelines.py --artifacts-root wsartifacts
            displayName: 'Validate Pipelines'
            continueOnError: false

          - script: |
              echo "Running artifact dependency checks..."
              python scripts/dependency_resolver.py
            displayName: 'Check Dependencies'

          - publish: $(System.DefaultWorkingDirectory)
            artifact: fabric-artifacts
            displayName: 'Publish artifacts'

  # ========================================
  # Stage 2: Deploy to Development
  # ========================================
  - stage: DeployDev
    displayName: 'Deploy to Development'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranchName'], 'dev'))
    jobs:
      - deployment: DeployToDev
        displayName: 'Deploy to Dev Environment'
        environment: 'fabric-dev'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  persistCredentials: true
                  fetchDepth: 0
                  displayName: 'Checkout source code'

                - task: UsePythonVersion@0
                  inputs:
                    versionSpec: '$(pythonVersion)'
                  displayName: 'Use Python $(pythonVersion)'

                - script: |
                    python -m pip install --upgrade pip
                    pip install -r $(Build.SourcesDirectory)/scripts/requirements.txt
                  displayName: 'Install dependencies'

                - script: |
                    echo "Installing Microsoft ODBC Driver 18 for SQL Server (required for SQL views)..."
                    curl https://packages.microsoft.com/keys/microsoft.asc | sudo tee /etc/apt/trusted.gpg.d/microsoft.asc
                    curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
                    sudo apt-get update
                    sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18
                    echo "Verifying ODBC driver installation..."
                    odbcinst -q -d
                    echo "‚úì ODBC Driver 18 for SQL Server installed successfully"
                  displayName: 'Install ODBC Driver for SQL Views'

                - script: |
                    set -e  # Exit immediately if any command fails
                    
                    echo "========================================"
                    echo "DEBUG: Verifying Repository Checkout"
                    echo "========================================"
                    echo "Current directory: $(pwd)"
                    echo "Build.SourcesDirectory: $(Build.SourcesDirectory)"
                    echo ""
                    echo "Contents of Build.SourcesDirectory:"
                    ls -la $(Build.SourcesDirectory) || echo "ERROR: Cannot list Build.SourcesDirectory"
                    echo ""
                    echo "Checking for required folders:"
                    test -d $(Build.SourcesDirectory)/scripts && echo "‚úì scripts/ exists" || echo "‚úó scripts/ NOT FOUND"
                    test -d $(Build.SourcesDirectory)/config && echo "‚úì config/ exists" || echo "‚úó config/ NOT FOUND"
                    test -d $(Build.SourcesDirectory)/wsartifacts && echo "‚úì wsartifacts/ exists" || echo "‚úó wsartifacts/ NOT FOUND"
                    echo "========================================"
                    
                    cd $(Build.SourcesDirectory)
                    
                    echo "========================================"
                    echo "Deploying to Dev Environment"
                    echo "========================================"
                    echo "Features:"
                    echo "  ‚ö° Automatic change detection (deploys only modified artifacts)"
                    echo "  üìä Dependency-aware deployment ordering"
                    echo "  üîó Auto-includes dependent artifacts (e.g., SQL views)"
                    echo ""
                    echo "Deployment steps:"
                    echo "  1. Create artifacts from config file"
                    echo "  2. Detect changed artifacts using Git diff"
                    echo "  3. Deploy only changed artifacts (use --force-all to override)"
                    echo "========================================"
                    
                    # Change detection is automatic - no special flags needed
                    python scripts/deploy_artifacts.py dev \
                      --config-dir config \
                      --artifacts-dir . \
                      --create-artifacts
                    
                    echo ""
                    echo "‚úì Dev deployment completed successfully"
                  displayName: 'Deploy to Dev Workspace (Change Detection Enabled)'
                  env:
                    AZURE_TENANT_ID: $(AZURE_TENANT_ID)
                    AZURE_CLIENT_ID: $(AZURE_CLIENT_ID_DEV)
                    AZURE_CLIENT_SECRET_DEV: $(AZURE_CLIENT_SECRET_DEV)

                - script: |
                    set -x  # Enable debug output
                    cd $(Build.SourcesDirectory)
                    
                    # Check if deployment tracking file was created
                    if [ -f .deployment_tracking/dev_last_commit.txt ]; then
                      echo "üìù Found deployment tracking file, committing..."
                      cat .deployment_tracking/dev_last_commit.txt
                      
                      # Configure git
                      git config user.email "azure-pipelines@fabcicd.com"
                      git config user.name "Azure Pipelines"
                      
                      # Add and commit the file
                      git add .deployment_tracking/dev_last_commit.txt
                      
                      # Check if there are changes to commit
                      if git diff --cached --quiet; then
                        echo "No changes to commit (file already up to date)"
                      else
                        echo "Committing changes..."
                        git commit -m "Update Dev deployment tracking [skip ci]"
                        
                        # Push to remote - using full ref path for Azure Repos
                        echo "Pushing to remote branch: $(Build.SourceBranch)..."
                        git push origin HEAD:refs/heads/$(Build.SourceBranch)
                        echo "‚úì Deployment tracking updated and pushed"
                      fi
                    else
                      echo "‚ö†Ô∏è  Deployment tracking file not found at .deployment_tracking/dev_last_commit.txt"
                      echo "Checking .deployment_tracking directory contents:"
                      ls -la .deployment_tracking/ || echo "Directory does not exist"
                    fi
                  displayName: 'Update deployment tracking'
                  continueOnError: true

  # ========================================
  # Stage 3: Deploy to UAT
  # ========================================
  - stage: DeployUAT
    displayName: 'Deploy to UAT'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranchName'], 'uat'))
    jobs:
      - deployment: DeployToUAT
        displayName: 'Deploy to UAT Environment'
        environment: 'fabric-uat'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  persistCredentials: true
                  fetchDepth: 0
                  displayName: 'Checkout source code'

                - task: UsePythonVersion@0
                  inputs:
                    versionSpec: '$(pythonVersion)'
                  displayName: 'Use Python $(pythonVersion)'

                - script: |
                    python -m pip install --upgrade pip
                    pip install -r $(Build.SourcesDirectory)/scripts/requirements.txt
                  displayName: 'Install dependencies'

                - script: |
                    echo "Installing Microsoft ODBC Driver 18 for SQL Server (required for SQL views)..."
                    curl https://packages.microsoft.com/keys/microsoft.asc | sudo tee /etc/apt/trusted.gpg.d/microsoft.asc
                    curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
                    sudo apt-get update
                    sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18
                    echo "Verifying ODBC driver installation..."
                    odbcinst -q -d
                    echo "‚úì ODBC Driver 18 for SQL Server installed successfully"
                  displayName: 'Install ODBC Driver for SQL Views'

                - script: |
                    set -e  # Exit immediately if any command fails
                    
                    echo "========================================"
                    echo "DEBUG: Verifying Repository Checkout"
                    echo "========================================"
                    echo "Current directory: $(pwd)"
                    echo "Build.SourcesDirectory: $(Build.SourcesDirectory)"
                    echo ""
                    echo "Contents of Build.SourcesDirectory:"
                    ls -la $(Build.SourcesDirectory) || echo "ERROR: Cannot list Build.SourcesDirectory"
                    echo ""
                    echo "Checking for required folders:"
                    test -d $(Build.SourcesDirectory)/scripts && echo "‚úì scripts/ exists" || echo "‚úó scripts/ NOT FOUND"
                    test -d $(Build.SourcesDirectory)/config && echo "‚úì config/ exists" || echo "‚úó config/ NOT FOUND"
                    test -d $(Build.SourcesDirectory)/wsartifacts && echo "‚úì wsartifacts/ exists" || echo "‚úó wsartifacts/ NOT FOUND"
                    echo "========================================"
                    
                    cd $(Build.SourcesDirectory)
                    
                    echo "========================================"
                    echo "Deploying to UAT Environment"
                    echo "========================================"
                    echo "Features:"
                    echo "  ‚ö° Automatic change detection (deploys only modified artifacts)"
                    echo "  üìä Dependency-aware deployment ordering"
                    echo "  üîó Auto-includes dependent artifacts (e.g., SQL views)"
                    echo ""
                    echo "Deployment steps:"
                    echo "  1. Create artifacts from config file"
                    echo "  2. Detect changed artifacts using Git diff"
                    echo "  3. Deploy only changed artifacts (use --force-all to override)"
                    echo "========================================"
                    
                    # Change detection is automatic - no special flags needed
                    python scripts/deploy_artifacts.py uat \
                      --config-dir config \
                      --artifacts-dir . \
                      --create-artifacts
                    
                    echo ""
                    echo "‚úì UAT deployment completed successfully"
                  displayName: 'Deploy to UAT Workspace (Change Detection Enabled)'
                  env:
                    AZURE_TENANT_ID: $(AZURE_TENANT_ID)
                    AZURE_CLIENT_ID: $(AZURE_CLIENT_ID_UAT)
                    AZURE_CLIENT_SECRET_UAT: $(AZURE_CLIENT_SECRET_UAT)

                - script: |
                    set -x  # Enable debug output
                    cd $(Build.SourcesDirectory)
                    
                    # Check if deployment tracking file was created
                    if [ -f .deployment_tracking/uat_last_commit.txt ]; then
                      echo "üìù Found deployment tracking file, committing..."
                      cat .deployment_tracking/uat_last_commit.txt
                      
                      # Configure git
                      git config user.email "azure-pipelines@fabcicd.com"
                      git config user.name "Azure Pipelines"
                      
                      # Add and commit the file
                      git add .deployment_tracking/uat_last_commit.txt
                      
                      # Check if there are changes to commit
                      if git diff --cached --quiet; then
                        echo "No changes to commit (file already up to date)"
                      else
                        echo "Committing changes..."
                        git commit -m "Update UAT deployment tracking [skip ci]"
                        
                        # Push to remote - using full ref path for Azure Repos
                        echo "Pushing to remote branch: $(Build.SourceBranch)..."
                        git push origin HEAD:refs/heads/$(Build.SourceBranch)
                        echo "‚úì Deployment tracking updated and pushed"
                      fi
                    else
                      echo "‚ö†Ô∏è  Deployment tracking file not found at .deployment_tracking/uat_last_commit.txt"
                      echo "Checking .deployment_tracking directory contents:"
                      ls -la .deployment_tracking/ || echo "Directory does not exist"
                    fi
                  displayName: 'Update deployment tracking'
                  continueOnError: true

  # ========================================
  # Stage 4: Deploy to Production
  # ========================================
  - stage: DeployProd
    displayName: 'Deploy to Production'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranchName'], 'main'))
    jobs:
      - deployment: DeployToProduction
        displayName: 'Deploy to Production Environment'
        environment: 'fabric-prod'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  persistCredentials: true
                  fetchDepth: 0
                  displayName: 'Checkout source code'

                - task: UsePythonVersion@0
                  inputs:
                    versionSpec: '$(pythonVersion)'
                  displayName: 'Use Python $(pythonVersion)'

                - script: |
                    python -m pip install --upgrade pip
                    pip install -r $(Build.SourcesDirectory)/scripts/requirements.txt
                  displayName: 'Install dependencies'

                - script: |
                    echo "Installing Microsoft ODBC Driver 18 for SQL Server (required for SQL views)..."
                    curl https://packages.microsoft.com/keys/microsoft.asc | sudo tee /etc/apt/trusted.gpg.d/microsoft.asc
                    curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
                    sudo apt-get update
                    sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18
                    echo "Verifying ODBC driver installation..."
                    odbcinst -q -d
                    echo "‚úì ODBC Driver 18 for SQL Server installed successfully"
                  displayName: 'Install ODBC Driver for SQL Views'

                - script: |
                    set -e  # Exit immediately if any command fails
                    
                    echo "========================================"
                    echo "DEBUG: Verifying Repository Checkout"
                    echo "========================================"
                    echo "Current directory: $(pwd)"
                    echo "Build.SourcesDirectory: $(Build.SourcesDirectory)"
                    echo ""
                    echo "Contents of Build.SourcesDirectory:"
                    ls -la $(Build.SourcesDirectory) || echo "ERROR: Cannot list Build.SourcesDirectory"
                    echo ""
                    echo "Checking for required folders:"
                    test -d $(Build.SourcesDirectory)/scripts && echo "‚úì scripts/ exists" || echo "‚úó scripts/ NOT FOUND"
                    test -d $(Build.SourcesDirectory)/config && echo "‚úì config/ exists" || echo "‚úó config/ NOT FOUND"
                    test -d $(Build.SourcesDirectory)/wsartifacts && echo "‚úì wsartifacts/ exists" || echo "‚úó wsartifacts/ NOT FOUND"
                    echo "========================================"
                    
                    cd $(Build.SourcesDirectory)
                    
                    echo "========================================"
                    echo "Deploying to Production Environment"
                    echo "========================================"
                    echo "Features:"
                    echo "  ‚ö° Automatic change detection (deploys only modified artifacts)"
                    echo "  üìä Dependency-aware deployment ordering"
                    echo "  üîó Auto-includes dependent artifacts (e.g., SQL views)"
                    echo ""
                    echo "Deployment steps:"
                    echo "  1. Create artifacts from config file"
                    echo "  2. Detect changed artifacts using Git diff"
                    echo "  3. Deploy only changed artifacts (use --force-all to override)"
                    echo "========================================"
                    
                    # Change detection is automatic - no special flags needed
                    # Add --force-all flag here if you want to force full deployment
                    python scripts/deploy_artifacts.py prod \
                      --config-dir config \
                      --artifacts-dir . \
                      --create-artifacts
                    
                    echo ""
                    echo "‚úì Production deployment completed successfully"
                  displayName: 'Deploy to Production Workspace (Change Detection Enabled)'
                  env:
                    AZURE_TENANT_ID: $(AZURE_TENANT_ID)
                    AZURE_CLIENT_ID: $(AZURE_CLIENT_ID_PROD)
                    AZURE_CLIENT_SECRET_PROD: $(AZURE_CLIENT_SECRET_PROD)

                - script: |
                    set -x  # Enable debug output
                    cd $(Build.SourcesDirectory)
                    
                    # Check if deployment tracking file was created
                    if [ -f .deployment_tracking/prod_last_commit.txt ]; then
                      echo "üìù Found deployment tracking file, committing..."
                      cat .deployment_tracking/prod_last_commit.txt
                      
                      # Configure git
                      git config user.email "azure-pipelines@fabcicd.com"
                      git config user.name "Azure Pipelines"
                      
                      # Add and commit the file
                      git add .deployment_tracking/prod_last_commit.txt
                      
                      # Check if there are changes to commit
                      if git diff --cached --quiet; then
                        echo "No changes to commit (file already up to date)"
                      else
                        echo "Committing changes..."
                        git commit -m "Update Production deployment tracking [skip ci]"
                        
                        # Push to remote - using full ref path for Azure Repos
                        echo "Pushing to remote branch: $(Build.SourceBranch)..."
                        git push origin HEAD:refs/heads/$(Build.SourceBranch)
                        echo "‚úì Deployment tracking updated and pushed"
                      fi
                    else
                      echo "‚ö†Ô∏è  Deployment tracking file not found at .deployment_tracking/prod_last_commit.txt"
                      echo "Checking .deployment_tracking directory contents:"
                      ls -la .deployment_tracking/ || echo "Directory does not exist"
                    fi
                  displayName: 'Update deployment tracking'
                  continueOnError: true

  # ========================================
  # Stage 5: Rollback (Manual trigger only)
  # ========================================
  - stage: Rollback
    displayName: 'Rollback Deployment'
    dependsOn: []
    condition: false  # This stage must be manually triggered
    jobs:
      - job: RollbackJob
        displayName: 'Rollback to Previous Version'
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(pythonVersion)'
            displayName: 'Use Python $(pythonVersion)'

          - script: |
              python -m pip install --upgrade pip
              pip install -r scripts/requirements.txt
            displayName: 'Install dependencies'

          - script: |
              # Run rollback
              python scripts/rollback.py \
                --environment $(ROLLBACK_ENVIRONMENT) \
                --commit $(ROLLBACK_COMMIT_SHA)
            displayName: 'Execute rollback'
            env:
              AZURE_TENANT_ID: $(AZURE_TENANT_ID)
              AZURE_CLIENT_ID: $(AZURE_CLIENT_ID)
              AZURE_CLIENT_SECRET: $(AZURE_CLIENT_SECRET)
