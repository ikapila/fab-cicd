# Microsoft Fabric Data Engineering CI/CD Pipeline
# Automated deployment of Fabric artifacts across environments

trigger:
  branches:
    include:
      - main      # Production deployment
      - uat       # UAT deployment
      - dev       # Development deployment
  paths:
    include:
      - wsartifacts/Notebooks/**
      - wsartifacts/Sparkjobdefinitions/**
      - wsartifacts/Datapipelines/**
      - wsartifacts/Lakehouses/**
      - wsartifacts/Environments/**
      - wsartifacts/Reports/**
      - wsartifacts/Semanticmodels/**
      - wsartifacts/Paginatedreports/**
      - wsartifacts/Variablelibraries/**
      - wsartifacts/Views/**
      - config/**
      - scripts/**

variables:
  pythonVersion: '3.11'
  
pool:
  vmImage: 'ubuntu-latest'

stages:
  # ========================================
  # Stage 1: Build and Validate
  # ========================================
  - stage: Build
    displayName: 'Build and Validate'
    jobs:
      - job: ValidateArtifacts
        displayName: 'Validate Fabric Artifacts'
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(pythonVersion)'
            displayName: 'Use Python $(pythonVersion)'

          - script: |
              python -m pip install --upgrade pip
              pip install -r scripts/requirements.txt
            displayName: 'Install Python dependencies'

          - script: |
              echo "Validating all artifacts in wsartifacts/ with capitalized folder names..."
              python scripts/validate_artifacts.py --artifacts-root wsartifacts
            displayName: 'Validate All Artifacts'
            continueOnError: false

          - script: |
              echo "Validating notebook syntax..."
              python scripts/validate_notebooks.py --artifacts-root wsartifacts
            displayName: 'Validate Notebooks'
            continueOnError: false

          - script: |
              echo "Validating pipeline definitions..."
              python scripts/validate_pipelines.py --artifacts-root wsartifacts
            displayName: 'Validate Pipelines'
            continueOnError: false

          - script: |
              echo "Running artifact dependency checks..."
              python scripts/dependency_resolver.py
            displayName: 'Check Dependencies'

          - publish: $(System.DefaultWorkingDirectory)
            artifact: fabric-artifacts
            displayName: 'Publish artifacts'

  # ========================================
  # Stage 2: Deploy to Development
  # ========================================
  - stage: DeployDev
    displayName: 'Deploy to Development'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranchName'], 'dev'))
    jobs:
      - deployment: DeployToDev
        displayName: 'Deploy to Dev Environment'
        environment: 'fabric-dev'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: fabric-artifacts

                - task: UsePythonVersion@0
                  inputs:
                    versionSpec: '$(pythonVersion)'
                  displayName: 'Use Python $(pythonVersion)'

                - script: |
                    python -m pip install --upgrade pip
                    pip install -r $(Pipeline.Workspace)/fabric-artifacts/scripts/requirements.txt
                  displayName: 'Install dependencies'

                - script: |
                    cd $(Pipeline.Workspace)/fabric-artifacts
                    
                    echo "========================================"
                    echo "Deploying to Dev Environment"
                    echo "This will:"
                    echo "1. Create artifacts from config file"
                    echo "2. Discover all artifacts in wsartifacts/ folders"
                    echo "3. Deploy all discovered artifacts (new and updated)"
                    echo "========================================"
                    
                    python scripts/deploy_artifacts.py dev \
                      --config-dir config \
                      --artifacts-dir . \
                      --create-artifacts
                    
                    echo "✓ Dev deployment completed successfully"
                  displayName: 'Deploy to Dev Workspace'
                  env:
                    AZURE_TENANT_ID: $(AZURE_TENANT_ID)
                    AZURE_CLIENT_ID: $(AZURE_CLIENT_ID_DEV)
                    AZURE_CLIENT_SECRET_DEV: $(AZURE_CLIENT_SECRET_DEV)

  # ========================================
  # Stage 3: Deploy to UAT
  # ========================================
  - stage: DeployUAT
    displayName: 'Deploy to UAT'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranchName'], 'uat'))
    jobs:
      - deployment: DeployToUAT
        displayName: 'Deploy to UAT Environment'
        environment: 'fabric-uat'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: fabric-artifacts

                - task: UsePythonVersion@0
                  inputs:
                    versionSpec: '$(pythonVersion)'
                  displayName: 'Use Python $(pythonVersion)'

                - script: |
                    python -m pip install --upgrade pip
                    pip install -r $(Pipeline.Workspace)/fabric-artifacts/scripts/requirements.txt
                  displayName: 'Install dependencies'

                - script: |
                    cd $(Pipeline.Workspace)/fabric-artifacts
                    
                    echo "========================================"
                    echo "Deploying to UAT Environment"
                    echo "This will:"
                    echo "1. Create artifacts from config file"
                    echo "2. Discover all artifacts in wsartifacts/ folders"
                    echo "3. Deploy all discovered artifacts (new and updated)"
                    echo "========================================"
                    
                    python scripts/deploy_artifacts.py uat \
                      --config-dir config \
                      --artifacts-dir . \
                      --create-artifacts
                    
                    echo "✓ UAT deployment completed successfully"
                  displayName: 'Deploy to UAT Workspace'
                  env:
                    AZURE_TENANT_ID: $(AZURE_TENANT_ID)
                    AZURE_CLIENT_ID: $(AZURE_CLIENT_ID_UAT)
                    AZURE_CLIENT_SECRET_UAT: $(AZURE_CLIENT_SECRET_UAT)

  # ========================================
  # Stage 4: Deploy to Production
  # ========================================
  - stage: DeployProd
    displayName: 'Deploy to Production'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranchName'], 'main'))
    jobs:
      - deployment: DeployToProduction
        displayName: 'Deploy to Production Environment'
        environment: 'fabric-prod'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: fabric-artifacts

                - task: UsePythonVersion@0
                  inputs:
                    versionSpec: '$(pythonVersion)'
                  displayName: 'Use Python $(pythonVersion)'

                - script: |
                    python -m pip install --upgrade pip
                    pip install -r $(Pipeline.Workspace)/fabric-artifacts/scripts/requirements.txt
                  displayName: 'Install dependencies'

                - script: |
                    cd $(Pipeline.Workspace)/fabric-artifacts
                    
                    echo "========================================"
                    echo "Deploying to Production Environment"
                    echo "This will:"
                    echo "1. Create artifacts from config file"
                    echo "2. Discover all artifacts in wsartifacts/ folders"
                    echo "3. Deploy all discovered artifacts (new and updated)"
                    echo "========================================"
                    
                    python scripts/deploy_artifacts.py prod \
                      --config-dir config \
                      --artifacts-dir . \
                      --create-artifacts
                    
                    echo "✓ Production deployment completed successfully"
                  displayName: 'Deploy to Production Workspace'
                  env:
                    AZURE_TENANT_ID: $(AZURE_TENANT_ID)
                    AZURE_CLIENT_ID: $(AZURE_CLIENT_ID_PROD)
                    AZURE_CLIENT_SECRET_PROD: $(AZURE_CLIENT_SECRET_PROD)
                  condition: always()

  # ========================================
  # Stage 5: Rollback (Manual trigger only)
  # ========================================
  - stage: Rollback
    displayName: 'Rollback Deployment'
    dependsOn: []
    condition: false  # This stage must be manually triggered
    jobs:
      - job: RollbackJob
        displayName: 'Rollback to Previous Version'
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(pythonVersion)'
            displayName: 'Use Python $(pythonVersion)'

          - script: |
              python -m pip install --upgrade pip
              pip install -r scripts/requirements.txt
            displayName: 'Install dependencies'

          - script: |
              # Run rollback
              python scripts/rollback.py \
                --environment $(ROLLBACK_ENVIRONMENT) \
                --commit $(ROLLBACK_COMMIT_SHA)
            displayName: 'Execute rollback'
            env:
              AZURE_TENANT_ID: $(AZURE_TENANT_ID)
              AZURE_CLIENT_ID: $(AZURE_CLIENT_ID)
              AZURE_CLIENT_SECRET: $(AZURE_CLIENT_SECRET)
